name: Fetch Data from Local API

on:
  schedule:
    - cron: '*/5 * * * *'  # Her 5 dakikada bir
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-data:
    runs-on: self-hosted
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch API Data
        id: fetch
        run: |
          echo "üéØ API'den veri alƒ±nƒ±yor..."
          
          # API'den veri al
          API_RESPONSE=$(curl -s \
            --max-time 30 \
            --retry 2 \
            --retry-delay 3 \
            "http://192.168.1.3:3000/api/emirler" || echo "ERROR")
          
          if [ "$API_RESPONSE" != "ERROR" ] && [ ! -z "$API_RESPONSE" ]; then
            mkdir -p public
            echo "$API_RESPONSE" > public/data.json
            
            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            
            # Python i√ßin √ßevre deƒüi≈ükenlerini ayarla
            export API_DATA_ENV="$API_RESPONSE"
            export TIMESTAMP_ENV="$TIMESTAMP"

            python3 << 'EOF'
import json
import sys
import os

try:
    raw_data = os.environ.get('API_DATA_ENV', '[]')
    timestamp = os.environ.get('TIMESTAMP_ENV', '')
    api_data = json.loads(raw_data)
    
    if isinstance(api_data, dict):
        emirler_list = api_data.get('emirler', [])
    elif isinstance(api_data, list):
        emirler_list = api_data
    else:
        emirler_list = []
    
    result = {
        "success": True,
        "lastFetch": timestamp,
        "source": "http://192.168.1.3:3000",
        "emirler": emirler_list
    }
    
    with open('public/api-data.json', 'w') as f:
        json.dump(result, f, indent=2)
    
    print(f"‚úÖ {len(emirler_list)} emir kaydedildi")
    sys.exit(0)
except Exception as e:
    print(f"‚ùå Hata: {e}")
    sys.exit(1)
EOF
            if [ $? -eq 0 ]; then
              echo "success=true" >> $GITHUB_OUTPUT
              COUNT=$(python3 -c "import json; d=json.load(open('public/api-data.json')); print(len(d.get('emirler', [])))")
              echo "count=$COUNT" >> $GITHUB_OUTPUT
            else
              echo "success=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå API hatasƒ±"
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push
        if: steps.fetch.outputs.success == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add public/
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Deƒüi≈üiklik yok."
            exit 0
          fi
          
          git commit -m "üìä Veri g√ºncellendi (${{ steps.fetch.outputs.count }} emir) - $(date +'%H:%M:%S')"
          git push origin main