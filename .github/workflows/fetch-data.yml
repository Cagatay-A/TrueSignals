name: Fetch Data from Local API

on:
  schedule:
    # Her 5 dakikada bir Ã§alÄ±ÅŸtÄ±r
    - cron: '*/5 * * * *'
  push:
    branches: [ main ]
  workflow_dispatch:  # Manuel Ã§alÄ±ÅŸtÄ±rma iÃ§in

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  fetch-data:
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup System Python on Raspberry Pi  # DEÄÄ°ÅTÄ°RÄ°LDÄ°!
      run: |
        echo "ğŸ”§ Raspberry Pi Ã¼zerinde sistem Python'u kullanÄ±lÄ±yor"
        echo "Python versiyonu: $(python3 --version 2>/dev/null || echo 'Python bulunamadÄ±')"
        echo "Python3 yolu: $(which python3 2>/dev/null || echo 'BulunamadÄ±')"
        
        # EÄŸer python3 yoksa kur
        if ! command -v python3 &> /dev/null; then
          echo "ğŸ“¦ Python3 kuruluyor..."
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
        fi
        
        # Pip'i kontrol et
        python3 -m ensurepip --upgrade 2>/dev/null || echo "Pip yÃ¼kseltilemedi, devam ediliyor"
        
        echo "âœ… Sistem Python hazÄ±r"
    
    - name: Create public directory if not exists
      run: |
        mkdir -p public
    
    - name: Fetch API Data with retry logic
      id: fetch-data
      run: |
        echo "ğŸ”„ Local API'den veri Ã§ekiliyor..."
        echo "ğŸŒ API URL: http://192.168.1.3:3000/api/emirler"
        
        # Retry mekanizmasÄ± (3 deneme)
        for i in {1..3}; do
          echo "ğŸ” Deneme $i/3..."
          
          # Curl ile API'den veri Ã§ek
          API_RESPONSE=$(curl -s \
            --max-time 30 \
            --retry 2 \
            --retry-delay 5 \
            --retry-max-time 60 \
            -H "User-Agent: GitHub-Actions-Fetcher/1.0" \
            -H "Accept: application/json" \
            -H "X-Requested-With: TrueSignal-Data-Fetch" \
            "http://192.168.1.3:3000/api/emirler" || echo "CURL_ERROR")
          
          # EÄŸer curl baÅŸarÄ±lÄ±ysa devam et
          if [ "$API_RESPONSE" != "CURL_ERROR" ] && [ ! -z "$API_RESPONSE" ]; then
            echo "âœ… API'den veri baÅŸarÄ±yla alÄ±ndÄ± (${#API_RESPONSE} karakter)"
            
            # JSON geÃ§erlilik kontrolÃ¼ - RASPBERRY Pi UYUMLU!
            if echo "$API_RESPONSE" | python3 -c "
import json
import sys

try:
    data = json.loads(sys.stdin.read())
    if isinstance(data, dict) or isinstance(data, list):
        print('VALID_JSON')
        sys.exit(0)
    else:
        print('INVALID_JSON_TYPE')
        sys.exit(1)
except json.JSONDecodeError:
    print('INVALID_JSON_SYNTAX')
    sys.exit(1)
except Exception as e:
    print(f'UNKNOWN_ERROR: {e}')
    sys.exit(1)
" > /dev/null 2>&1; then
              echo "âœ… JSON formatÄ± geÃ§erli"
              
              # Veriyi kaydet
              echo "$API_RESPONSE" > public/data.json
              
              # Metadata ekle
              TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              echo '{ "success": true, "lastFetch": "'$TIMESTAMP'", "source": "http://192.168.1.3:3000", "emirler": '"$API_RESPONSE"' }' > public/api-data.json
              
              # Ä°statistikleri hesapla - RASPBERRY Pi UYUMLU!
              COUNT=$(echo "$API_RESPONSE" | python3 -c "
import json
import sys

try:
    data = json.loads(sys.stdin.read())
    if isinstance(data, dict):
        count = len(data.get('emirler', [])) if 'emirler' in data else len(data)
    elif isinstance(data, list):
        count = len(data)
    else:
        count = 0
    print(count)
except:
    print(0)
")
              echo "ğŸ“Š $COUNT emir bulundu"
              
              echo "success=true" >> $GITHUB_OUTPUT
              echo "count=$COUNT" >> $GITHUB_OUTPUT
              break
            else
              echo "âŒ GeÃ§ersiz JSON formatÄ±"
            fi
          else
            echo "âŒ API'ye baÄŸlanÄ±lamadÄ± (Deneme $i)"
            sleep 5
          fi
          
          if [ $i -eq 3 ]; then
            echo "âŒ TÃ¼m denemeler baÅŸarÄ±sÄ±z, fallback veri kullanÄ±lacak"
          fi
        done
        
        # EÄŸer tÃ¼m denemeler baÅŸarÄ±sÄ±z olursa fallback veri oluÅŸtur
        if [ ! -f public/data.json ]; then
          echo "âš ï¸  Fallback veri oluÅŸturuluyor..."
          
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Fallback veri (API down olduÄŸunda)
          FALLBACK_DATA='[
            {
              "Id": 999,
              "Tarih/Saat": "'$(date +"%Y-%m-%d %H:%M:%S")'",
              "Sembol": "API_UNAVAILABLE",
              "Tip": "INFO",
              "Lot": 0,
              "GirisFiyati": 0,
              "StopLoss": 0,
              "TakeProfit": 0,
              "KapanisFiyati": 0,
              "RSI": 0,
              "MACD": "API KapalÄ±",
              "EMA": "API KapalÄ±",
              "STOACH": "API KapalÄ±",
              "Durum": "API KapalÄ±",
              "ListType": "Sistem",
              "KarZarar": 0,
              "KarZararYuzde": 0
            }
          ]'
          
          echo "$FALLBACK_DATA" > public/data.json
          echo '{ "success": false, "lastFetch": "'$TIMESTAMP'", "source": "fallback", "message": "API temporarily unavailable", "emirler": '"$FALLBACK_DATA"' }' > public/api-data.json
          
          echo "success=false" >> $GITHUB_OUTPUT
          echo "count=1" >> $GITHUB_OUTPUT
        fi
    
    - name: Validate JSON files
      run: |
        echo "ğŸ” JSON dosyalarÄ± kontrol ediliyor..."
        
        # api-data.json kontrolÃ¼ - RASPBERRY Pi UYUMLU!
        if [ -f public/api-data.json ]; then
          echo "ğŸ“ api-data.json:"
          python3 -c "
import json
import sys

try:
    with open('public/api-data.json', 'r') as f:
        data = json.load(f)
    print('âœ… api-data.json geÃ§erli')
    print(f'ğŸ“ Boyut: {len(json.dumps(data))} bytes')
except Exception as e:
    print(f'âŒ api-data.json geÃ§ersiz: {e}')
" 2>/dev/null || echo "âŒ api-data.json kontrolÃ¼ baÅŸarÄ±sÄ±z"
        fi
        
        # data.json kontrolÃ¼
        if [ -f public/data.json ]; then
          echo "ğŸ“ data.json:"
          python3 -c "
import json
import sys

try:
    with open('public/data.json', 'r') as f:
        data = json.load(f)
    print('âœ… data.json geÃ§erli')
    print(f'ğŸ“ Boyut: {len(json.dumps(data))} bytes')
except Exception as e:
    print(f'âŒ data.json geÃ§ersiz: {e}')
" 2>/dev/null || echo "âŒ data.json kontrolÃ¼ baÅŸarÄ±sÄ±z"
        fi
        
        # Ã–rnek veriyi gÃ¶ster
        echo "ğŸ“‹ Ã–rnek veri (ilk 500 karakter):"
        head -c 500 public/api-data.json 2>/dev/null && echo "..." || echo "Dosya okunamadÄ±"
    
    - name: Create README for public folder
      run: |
        cat > public/README.md << 'EOF'
        # Public Data Files
        
        Bu klasÃ¶r GitHub Actions tarafÄ±ndan otomatik olarak oluÅŸturulur.
        
        ## Dosyalar
        
        - `data.json`: Ham API verisi
        - `api-data.json`: Metadata ile zenginleÅŸtirilmiÅŸ API verisi
        
        ## Veri AkÄ±ÅŸÄ±
        
        1. GitHub Actions her 5 dakikada bir Ã§alÄ±ÅŸÄ±r
        2. Local API'den (http://192.168.1.3:3000) veri Ã§eker
        3. JSON formatÄ±nda bu klasÃ¶re kaydeder
        4. GitHub Pages Ã¼zerinden servis edilir
        
        ## API Endpoint
        
        ```json
        GET https://cagatay-a.github.io/TrueSignal/api-data.json
        ```
        
        ## Ã–rnek YanÄ±t
        
        ```json
        {
          "success": true,
          "lastFetch": "2024-01-18T12:00:00Z",
          "source": "http://192.168.1.3:3000",
          "emirler": [...]
        }
        ```
        
        ## Manuel Tetikleme
        
        GitHub Actions sayfasÄ±ndan "Run workflow" butonuna tÄ±klayarak manuel tetikleyebilirsiniz.
        EOF
    
    - name: Commit and Push changes
      id: commit-push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ’¾ DeÄŸiÅŸiklikler commit ediliyor..."
        
        # Git ayarlarÄ±
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        # DeÄŸiÅŸiklikleri kontrol et
        git status
        
        # DeÄŸiÅŸiklikleri ekle
        git add public/
        
        # Commit mesajÄ± oluÅŸtur
        TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
        if [ "${{ steps.fetch-data.outputs.success }}" = "true" ]; then
          COMMIT_MSG="ğŸ“Š API Verileri GÃ¼ncellendi (${{ steps.fetch-data.outputs.count }} emir) - $TIMESTAMP"
        else
          COMMIT_MSG="âš ï¸  Fallback Veri KullanÄ±ldÄ± (API KapalÄ±) - $TIMESTAMP"
        fi
        
        # Commit yap
        git commit -m "$COMMIT_MSG" || echo "âš ï¸  Commit yapÄ±lamadÄ± (muhtemelen deÄŸiÅŸiklik yok)"
        
        # Push yap
        echo "ğŸš€ DeÄŸiÅŸiklikler push ediliyor..."
        git push origin main
        
        echo "âœ… Ä°ÅŸlem tamamlandÄ±"
        
        # SonuÃ§larÄ± output'a ekle
        echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
    
    - name: Summary
      run: |
        echo "ğŸ‰ GitHub Actions Ä°ÅŸlemi TamamlandÄ±"
        echo "====================================="
        echo "ğŸ“… Zaman: $(date)"
        echo "âœ… BaÅŸarÄ±lÄ±: ${{ steps.fetch-data.outputs.success }}"
        echo "ğŸ“Š Emir SayÄ±sÄ±: ${{ steps.fetch-data.outputs.count }}"
        echo "ğŸ’¾ Commit: ${{ steps.commit-push.outputs.commit_message }}"
        echo "ğŸŒ EriÅŸilebilir: https://cagatay-a.github.io/TrueSignal/api-data.json"
        echo "ğŸ“± Sayfa: https://cagatay-a.github.io/TrueSignal/"
        echo "====================================="
        
        # Son 5 commit'i gÃ¶ster
        echo "ğŸ“ Son 5 commit:"
        git log --oneline -5
        
        # Dosya durumunu gÃ¶ster
        echo "ğŸ“ Public klasÃ¶rÃ¼ iÃ§eriÄŸi:"
        ls -la public/