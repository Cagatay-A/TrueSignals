name: Fetch Data from Local API

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

permissions:
  contents: write

jobs:
  fetch-data:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch API and generate api-data.json
        id: fetch
        run: |
          set -e

          echo "Local API çağrılıyor..."
          RESPONSE=$(curl -s http://192.168.1.3:3000/api/emirler)

          if [ -z "$RESPONSE" ]; then
            echo "API boş cevap döndü"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          mkdir -p public
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          python3 <<EOF
import json

data = json.loads('''$RESPONSE''')

if isinstance(data, dict) and "emirler" in data:
    emirler = data["emirler"]
elif isinstance(data, list):
    emirler = data
else:
    emirler = []

result = {
    "success": True,
    "lastFetch": "$TIMESTAMP",
    "source": "http://192.168.1.3:3000",
    "emirler": emirler
}

with open("public/api-data.json", "w") as f:
    json.dump(result, f, indent=2)
EOF

          COUNT=$(python3 -c "import json;print(len(json.load(open('public/api-data.json'))['emirler']))")

          echo "success=true" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Commit and Push
        if: steps.fetch.outputs.success == 'true'
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          git add public/api-data.json

          if git diff --cached --quiet; then
            echo "Değişiklik yok, commit atlanıyor"
            exit 0
          fi

          git commit -m "Update api-data.json"
          git push origin main

      - name: Summary
        run: |
          echo "Başarılı: ${{ steps.fetch.outputs.success }}"
          echo "Emir sayısı: ${{ steps.fetch.outputs.count }}"
          echo "URL: https://cagatay-a.github.io/TrueSignals/api-data.json"
