name: Fetch Data from Local API

on:
  schedule:
    - cron: '*/5 * * * *'  # Her 5 dakikada bir
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-data:
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Fetch API Data
      id: fetch
      run: |
        echo "ğŸ¯ API'den veri alÄ±nÄ±yor..."
        
        # API'den veri al
        API_RESPONSE=$(curl -s \
          --max-time 30 \
          --retry 2 \
          --retry-delay 3 \
          "http://192.168.1.3:3000/api/emirler" || echo "ERROR")
        
        if [ "$API_RESPONSE" != "ERROR" ] && [ ! -z "$API_RESPONSE" ]; then
          mkdir -p public
          
          # Ham API yanÄ±tÄ±nÄ± kaydet
          echo "$API_RESPONSE" > public/data.json
          
          # DOÄRU FORMAT: API'den gelen emirler dizisini Ã§Ä±kar
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Python ile JSON iÅŸleme - EMRÄ°LER DÄ°ZÄ°SÄ°NÄ° Ã‡IKAR
          python3 << 'EOF'
import json
import sys

try:
    # API yanÄ±tÄ±nÄ± oku
    api_data = json.loads('''$API_RESPONSE''')
    
    # emirler dizisini bul
    if isinstance(api_data, dict):
        emirler_list = api_data.get('emirler', [])
    elif isinstance(api_data, list):
        emirler_list = api_data
    else:
        emirler_list = []
    
    # DoÄŸru formatta kaydet
    result = {
        "success": True,
        "lastFetch": "$TIMESTAMP",
        "source": "http://192.168.1.3:3000",
        "emirler": emirler_list
    }
    
    with open('public/api-data.json', 'w') as f:
        json.dump(result, f, indent=2)
    
    print(f"âœ… {len(emirler_list)} emir kaydedildi")
    sys.exit(0)
    
except json.JSONDecodeError as e:
    print(f"âŒ JSON decode hatasÄ±: {e}")
    # Fallback
    with open('public/api-data.json', 'w') as f:
        json.dump({"success": False, "error": "Invalid JSON"}, f)
    sys.exit(1)
except Exception as e:
    print(f"âŒ Genel hata: {e}")
    with open('public/api-data.json', 'w') as f:
        json.dump({"success": False, "error": str(e)}, f)
    sys.exit(1)
EOF
          
          # BaÅŸarÄ± durumunu kaydet
          if [ $? -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "count=$(python3 -c "import json; d=json.load(open('public/api-data.json')); print(len(d.get('emirler', [])))")" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "count=0" >> $GITHUB_OUTPUT
          fi
          
        else
          echo "âŒ API hatasÄ±"
          echo "success=false" >> $GITHUB_OUTPUT
          echo "count=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Show result
      run: |
        echo "ğŸ“Š Ä°ÅŸlem sonucu:"
        ls -la public/ 2>/dev/null || echo "public/ klasÃ¶rÃ¼ yok"
        echo ""
        echo "ğŸ“„ api-data.json Ã¶nizleme:"
        head -c 300 public/api-data.json 2>/dev/null || echo "Dosya okunamadÄ±"
        echo "..."

    - name: Commit and Push
      if: steps.fetch.outputs.success == 'true'
      run: |
        echo "ğŸ’¾ Git iÅŸlemleri..."
        
        # Git ayarlarÄ±
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Remote'dan gÃ¼ncel veriyi al
        echo "ğŸ”„ Remote senkronizasyonu..."
        git fetch origin
        git reset --hard origin/main
        
        # DosyalarÄ± ekle
        git add public/
        
        # DeÄŸiÅŸiklik kontrolÃ¼
        if git diff --staged --quiet; then
          echo "â„¹ï¸ DeÄŸiÅŸiklik yok, commit atlanÄ±yor."
          exit 0
        fi
        
        # Commit yap
        echo "ğŸ’¾ Commit yapÄ±lÄ±yor..."
        git commit -m "ğŸ“Š Veri gÃ¼ncellendi (${{ steps.fetch.outputs.count }} emir) - $(date +'%H:%M:%S')"
        
        # Push yap (token otomatik kullanÄ±lÄ±r)
        echo "ğŸš€ Push yapÄ±lÄ±yor..."
        git push origin main
        
        echo "âœ… TÃ¼m iÅŸlemler tamamlandÄ±!"

    - name: Summary
      run: |
        echo "========================================"
        echo "ğŸ‰ GitHub Actions Ä°ÅŸlemi TamamlandÄ±"
        echo "========================================"
        echo "âœ… BaÅŸarÄ±lÄ±: ${{ steps.fetch.outputs.success }}"
        echo "ğŸ“Š Emir SayÄ±sÄ±: ${{ steps.fetch.outputs.count }}"
        echo "ğŸŒ EriÅŸilebilir: https://cagatay-a.github.io/TrueSignals/api-data.json"
        echo "ğŸ“± Sayfa: https://cagatay-a.github.io/TrueSignals/"
        echo "========================================"