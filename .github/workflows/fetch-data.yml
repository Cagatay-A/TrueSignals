name: Fetch Trading Data

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  fetch-data:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch data from local API
        run: |
          curl -s http://192.168.1.3:3000/api/emirler > raw.json

      - name: Normalize JSON for frontend
        run: |
          python3 << 'EOF'
          import json
          from datetime import datetime

          with open("raw.json", "r", encoding="utf-8") as f:
              raw = json.load(f)

          # Emir listesi nerede olursa olsun çek
          emirler = []

          if isinstance(raw, dict):
              if "emirler" in raw:
                  if isinstance(raw["emirler"], list):
                      emirler = raw["emirler"]
                  elif isinstance(raw["emirler"], dict) and "emirler" in raw["emirler"]:
                      emirler = raw["emirler"]["emirler"]

          output = {
              "success": True,
              "lastFetch": datetime.utcnow().isoformat() + "Z",
              "source": "http://192.168.1.3:3000",
              "emirler": emirler
          }

          with open("public/api-data.json", "w", encoding="utf-8") as f:
              json.dump(output, f, ensure_ascii=False, indent=2)

          print(f"[OK] {len(emirler)} emir yazıldı.")
          EOF

      - name: Commit and push if changed
        run: |
          if git status --porcelain | grep api-data.json; then
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add public/api-data.json
            git commit -m "Update api-data.json from local API"
            git push
          else
            echo "No changes to commit."
          fi
