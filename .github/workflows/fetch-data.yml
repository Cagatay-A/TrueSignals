name: Fetch Data from Local API

on:
  schedule:
    - cron: '*/5 * * * *'   # Her 5 dakikada bir
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-data:
    runs-on: self-hosted

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Fetch API Data
      id: fetch
      run: |
        echo "ğŸ¯ API'den veri alÄ±nÄ±yor..."

        API_URL="http://192.168.1.3:3000/api/emirler"
        TMP_API_FILE="/tmp/api-response.json"

        # API Ã§aÄŸrÄ±sÄ±
        if ! curl -s --max-time 30 --retry 2 --retry-delay 3 "$API_URL" -o "$TMP_API_FILE"; then
          echo "âŒ API eriÅŸim hatasÄ±"
          echo "success=false" >> $GITHUB_OUTPUT
          echo "count=0" >> $GITHUB_OUTPUT
          exit 0
        fi

        if [ ! -s "$TMP_API_FILE" ]; then
          echo "âŒ API boÅŸ yanÄ±t dÃ¶ndÃ¼"
          echo "success=false" >> $GITHUB_OUTPUT
          echo "count=0" >> $GITHUB_OUTPUT
          exit 0
        fi

        mkdir -p public
        cp "$TMP_API_FILE" public/data.json

        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        # JSON iÅŸleme (gÃ¼venli)
        python3 << 'EOF'
import json
import sys

try:
    with open("/tmp/api-response.json") as f:
        api_data = json.load(f)

    if isinstance(api_data, dict):
        emirler = api_data.get("emirler", [])
    elif isinstance(api_data, list):
        emirler = api_data
    else:
        emirler = []

    result = {
        "success": True,
        "lastFetch": "$TIMESTAMP",
        "source": "http://192.168.1.3:3000",
        "emirler": emirler
    }

    with open("public/api-data.json", "w") as f:
        json.dump(result, f, indent=2)

    print(f"âœ… {len(emirler)} emir kaydedildi")
    sys.exit(0)

except Exception as e:
    print(f"âŒ Hata: {e}")
    with open("public/api-data.json", "w") as f:
        json.dump({"success": False, "error": str(e)}, f)
    sys.exit(1)
EOF

        if [ $? -eq 0 ]; then
          COUNT=$(python3 -c "import json; print(len(json.load(open('public/api-data.json')).get('emirler', [])))")
          echo "success=true" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "count=0" >> $GITHUB_OUTPUT
        fi

    - name: Show result
      run: |
        echo "ğŸ“‚ public/ iÃ§eriÄŸi:"
        ls -la public || true
        echo ""
        echo "ğŸ“„ api-data.json (ilk 300 byte):"
        head -c 300 public/api-data.json || true
        echo ""

    - name: Commit and Push
      if: steps.fetch.outputs.success == 'true'
      run: |
        echo "ğŸ’¾ Git iÅŸlemleri baÅŸlÄ±yor..."

        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        git add public/

        if git diff --staged --quiet; then
          echo "â„¹ï¸ DeÄŸiÅŸiklik yok, commit atlanÄ±yor."
          exit 0
        fi

        git commit -m "ğŸ“Š Veri gÃ¼ncellendi (${{ steps.fetch.outputs.count }} emir) - $(date +'%H:%M:%S')"

        echo "ğŸš€ Push yapÄ±lÄ±yor..."
        git push origin main

        echo "âœ… Git iÅŸlemleri tamamlandÄ±"

    - name: Summary
      run: |
        echo "========================================"
        echo "ğŸ‰ GitHub Actions Ä°ÅŸlemi TamamlandÄ±"
        echo "========================================"
        echo "âœ… BaÅŸarÄ±lÄ±: ${{ steps.fetch.outputs.success }}"
        echo "ğŸ“Š Emir SayÄ±sÄ±: ${{ steps.fetch.outputs.count }}"
        echo "ğŸŒ API JSON: https://cagatay-a.github.io/TrueSignals/api-data.json"
        echo "ğŸ“± Site: https://cagatay-a.github.io/TrueSignals/"
        echo "========================================"
