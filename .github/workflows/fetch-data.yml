name: Fetch Data from Local API

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  fetch-data:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch API Data
        id: fetch
        run: |
          set -e

          echo "API'den veri alınıyor..."

          API_RESPONSE=$(curl -s --max-time 20 http://192.168.1.3:3000/api/emirler)

          if [ -z "$API_RESPONSE" ]; then
            echo "success=false" >> $GITHUB_OUTPUT
            echo "count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          mkdir -p public

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          python3 <<EOF
import json

api = json.loads('''$API_RESPONSE''')

emirler = []

if isinstance(api, dict) and "emirler" in api:
    emirler = api["emirler"]
elif isinstance(api, list):
    emirler = api

result = {
    "success": True,
    "lastFetch": "$TIMESTAMP",
    "source": "http://192.168.1.3:3000",
    "emirler": emirler
}

with open("public/api-data.json", "w") as f:
    json.dump(result, f, indent=2)
EOF

          COUNT=$(python3 -c "import json;print(len(json.load(open('public/api-data.json'))['emirler']))")

          echo "success=true" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Commit and Push
        if: steps.fetch.outputs.success == 'true'
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          git add public/api-data.json

          if git diff --cached --quiet; then
            echo "Değişiklik yok"
            exit 0
          fi

          git commit -m "Update API data (${{
            steps.fetch.outputs.count
          }} emir)"

          git push origin main

      - name: Summary
        run: |
          echo "Success: ${{ steps.fetch.outputs.success }}"
          echo "Count:   ${{ steps.fetch.outputs.count }}"
          echo "URL: https://cagatay-a.github.io/TrueSignals/api-data.json"
