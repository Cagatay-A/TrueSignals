
name: Fetch Data from Local API

on:
  schedule:
    # Her 5 dakikada bir Ã§alÄ±ÅŸtÄ±r
    - cron: '*/5 * * * *'
  push:
    branches: [ main ]
  workflow_dispatch:  # Manuel Ã§alÄ±ÅŸtÄ±rma iÃ§in

permissions:
  contents: write

jobs:
  fetch-data:
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create public directory
      run: |
        echo "ğŸ“ Public klasÃ¶rÃ¼ oluÅŸturuluyor..."
        mkdir -p public
    
    - name: Fetch API Data with retry logic
      id: fetch-data
      run: |
        echo "ğŸ”„ Local API'den veri Ã§ekiliyor..."
        echo "ğŸŒ API URL: http://192.168.1.3:3000/api/emirler"
        
        # Retry mekanizmasÄ± (3 deneme)
        for i in {1..3}; do
          echo "ğŸ” Deneme $i/3..."
          
          # Curl ile API'den veri Ã§ek
          API_RESPONSE=$(curl -s \
            --max-time 10 \
            --retry 1 \
            --retry-delay 2 \
            -H "Accept: application/json" \
            "http://192.168.1.3:3000/api/emirler" || echo "CURL_ERROR")
          
          # EÄŸer curl baÅŸarÄ±lÄ±ysa devam et
          if [ "$API_RESPONSE" != "CURL_ERROR" ] && [ ! -z "$API_RESPONSE" ]; then
            echo "âœ… API'den veri alÄ±ndÄ± (${#API_RESPONSE} karakter)"
            
            # BASÄ°T JSON kontrolÃ¼ - TEK SATIR
            if echo "$API_RESPONSE" | python3 -c "import json,sys; json.loads(sys.stdin.read())" 2>/dev/null; then
              echo "âœ… JSON formatÄ± geÃ§erli"
              
              # Veriyi kaydet
              echo "$API_RESPONSE" > public/data.json
              
              # Metadata ekle
              TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              echo '{ "success": true, "lastFetch": "'$TIMESTAMP'", "source": "http://192.168.1.3:3000", "emirler": '"$API_RESPONSE"' }' > public/api-data.json
              
              # Ä°statistikleri hesapla - TEK SATIR
              COUNT=$(echo "$API_RESPONSE" | python3 -c "import json,sys; d=json.loads(sys.stdin.read()); print(len(d) if isinstance(d, list) else (len(d.get('emirler', [])) if isinstance(d, dict) and 'emirler' in d else 1))")
              echo "ğŸ“Š $COUNT emir bulundu"
              
              echo "success=true" >> $GITHUB_OUTPUT
              echo "count=$COUNT" >> $GITHUB_OUTPUT
              break
            else
              echo "âŒ GeÃ§ersiz JSON formatÄ±"
            fi
          else
            echo "âŒ API'ye baÄŸlanÄ±lamadÄ± (Deneme $i)"
            sleep 2
          fi
        done
        
        # EÄŸer tÃ¼m denemeler baÅŸarÄ±sÄ±z olursa fallback veri oluÅŸtur
        if [ ! -f public/data.json ]; then
          echo "âš ï¸ Fallback veri oluÅŸturuluyor..."
          
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Fallback veri
          FALLBACK_DATA='[{"Id":999,"Sembol":"API_UNAVAILABLE","Tip":"INFO","Durum":"API KapalÄ±","EmirZamani":"'$(date +"%Y-%m-%d %H:%M:%S")'"}]'
          
          echo "$FALLBACK_DATA" > public/data.json
          echo '{ "success": false, "lastFetch": "'$TIMESTAMP'", "source": "fallback", "message": "API temporarily unavailable", "emirler": '"$FALLBACK_DATA"' }' > public/api-data.json
          
          echo "success=false" >> $GITHUB_OUTPUT
          echo "count=1" >> $GITHUB_OUTPUT
        fi
    
    - name: Show files
      run: |
        echo "ğŸ“ OluÅŸturulan dosyalar:"
        ls -la public/
        echo ""
        echo "ğŸ“„ api-data.json Ã¶nizleme:"
        head -c 300 public/api-data.json 2>/dev/null || echo "Dosya yok"
        echo "..."
    
    - name: Commit and Push changes
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: |
    echo "ğŸ’¾ DeÄŸiÅŸiklikler kaydediliyor..."
    
    # Git ayarlarÄ±
    git config --local user.email "action@github.com"
    git config --local user.name "GitHub Action"
    
    # DeÄŸiÅŸiklikleri ekle
    git add public/
    
    # HER ZAMAN COMMIT YAP
    git commit -m "ğŸ“Š API Verileri GÃ¼ncellendi (${{ steps.fetch-data.outputs.count || 0 }} emir) - $(date +'%H:%M:%S')" --allow-empty
    
    echo "ğŸš€ DeÄŸiÅŸiklikler gÃ¶nderiliyor..."
    git push
    echo "âœ… GÃ¶nderim tamamlandÄ±"

    
    - name: Summary
      run: |
        echo "====================================="
        echo "ğŸ‰ GitHub Actions Ä°ÅŸlemi TamamlandÄ±"
        echo "====================================="
        echo "âœ… BaÅŸarÄ±lÄ±: ${{ steps.fetch-data.outputs.success }}"
        echo "ğŸ“Š Emir SayÄ±sÄ±: ${{ steps.fetch-data.outputs.count }}"
        echo "ğŸŒ JSON URL: https://cagatay-a.github.io/TrueSignals/api-data.json"
        echo "ğŸ“± Sayfa: https://cagatay-a.github.io/TrueSignals/"
        echo "====================================="