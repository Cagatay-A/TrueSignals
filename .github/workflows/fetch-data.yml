name: Fetch Data from Local API

on:
  schedule:
    - cron: '*/5 * * * *'
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-data:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch API Data
        id: fetch
        run: |
          echo "ðŸŽ¯ API'den veri alÄ±nÄ±yor..."
          mkdir -p public
          RESPONSE=$(curl -s --max-time 30 "http://192.168.1.3:3000/api/emirler" || echo "ERROR")
          
          if [ "$RESPONSE" != "ERROR" ] && [ ! -z "$RESPONSE" ]; then
            echo "$RESPONSE" > public/data.json
            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            
            # Python kodunu tek satÄ±rda gÃ¼venli Ã§alÄ±ÅŸtÄ±rÄ±yoruz
            python3 -c "
import json, os
try:
    with open('public/data.json', 'r') as f: api_data = json.load(f)
    emirler = api_data.get('emirler', []) if isinstance(api_data, dict) else api_data
    result = {'success': True, 'lastFetch': '$TIMESTAMP', 'source': 'local-api', 'emirler': emirler}
    with open('public/api-data.json', 'w') as f: json.dump(result, f, indent=2)
    print(f'SUCCESS_{len(emirler)}')
except Exception as e:
    print(f'ERROR_{e}')
            " > result.txt
            
            RESULT=$(cat result.txt)
            if [[ $RESULT == SUCCESS* ]]; then
              echo "success=true" >> $GITHUB_OUTPUT
              echo "count=${RESULT#SUCCESS_}" >> $GITHUB_OUTPUT
            else
              echo "success=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push
        if: steps.fetch.outputs.success == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add public/
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ“Š Veri: ${{ steps.fetch.outputs.count }} emir - $(date +'%H:%M')"
            git push origin main
          fi